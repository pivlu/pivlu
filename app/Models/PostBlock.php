<?php

/**
 * Pivlu - Open source CMS (Content Management System).
 * Pivlu comes with the complete suite of tools that any business, team, or website owner needs.
 * https://pivlu.com
 *
 * Copyright (c) Chimilevschi Iosif-Gabriel
 * LICENSE:
 * Permissions of this strongest copyleft license are conditioned on making available complete source code 
 * of licensed works and modifications, which include larger works using a licensed work, under the same license. 
 * Copyright and license notices must be preserved. Contributors provide an express grant of patent rights. 
 * When a modified version is used to provide a service over a network, the complete source code of the modified version must be made available.
 *    
 * @copyright   Copyright (c) Chimilevschi Iosif-Gabriel
 * @license     https://opensource.org/license/agpl-v3  AGPL-3.0 License.
 * @author      Chimilevschi Iosif-Gabriel <office@pivlu.com>
 * 
 *  DO NOT edit this file manually. All changes will be lost after software update. For custom changes, use templates ans plugins system.
 */

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\Validator;
use App\Http\Controllers\TextTransform;

class PostBlock extends Model
{

    protected $fillable = [
        'type',
        'label',
        'content',
        'header',
        'settings',
        'module',
        'post_id',
        'template_id',
        'position',
        'hide',
        'created_by_user_id',
        'updated_by_user_id',
    ];

    protected $table = 'blocks';


    /**
     * 
     * @return \Illuminate\Database\Eloquent\Relations\hasOne
     */
    public function content()
    {
        return $this->hasOne(BlockContent::class, 'block_id');
    }
    

    public static function update_block($id, $type, $request)
    {
        $inputs = $request->except('_token');        

        $block_module = PostBlock::where('id', $id)->value('module');

       
        // Extra content EDITOR            
        if ($type == 'editor') {
            $content = $inputs['content'];

            $transformer = new TextTransform();
            $clean_content = $transformer->keepTags()->keepNewLines()->toText($content);
            $clean_content = trim($clean_content);

            // header data
            $header_array = array();
            $header_array = array('add_header' => $inputs['add_header'] ?? null, 'title' =>  $inputs["header_title"] ?? null, 'content' =>  $inputs["header_content"] ?? null);
            $header_content = serialize($header_array);

            PostBlock::where('id', $id)->update(['content' => $clean_content, 'header' => $header_content]);
        }



        // Extra content ALERT            
        if ($type == 'alert') {
            $block_settings = array('type' => null);
            if ($inputs['alert_type'] ?? null) $block_settings['type'] = $inputs['alert_type'];

            $content_array = array('title' => $inputs["title"], 'content' => $inputs["content"]);
            $content = serialize($content_array);

            PostBlock::where('id', $id)->update(['settings' => serialize($block_settings), 'content' => $content]);
        }


        // Extra content VIDEO               
        if ($type == 'video') {
            $block_settings = array('full_width_responsive' => null);
            if ($inputs['full_width_responsive'] ?? null) $block_settings['full_width_responsive'] = $inputs['full_width_responsive'];

            $content = array('embed' => $request['embed'], 'caption' => $request['caption']);
            $content = serialize($content);

            // header data
            $header_array = array();
            $header_array = array('add_header' => $inputs['add_header'] ?? null, 'title' =>  $inputs["header_title"] ?? null, 'content' =>  $inputs["header_content"] ?? null);
            $header_content = serialize($header_array);


            PostBlock::where('id', $id)->update(['settings' => serialize($block_settings), 'header' => $header_content, 'content' => $content]);
        }

        // Extra content IMAGE      
        if ($type == 'image') {
            $block_settings = array('shadow' => null, 'rounded' => null);
            if ($inputs['shadow'] ?? null) $block_settings['shadow'] = $inputs['shadow'];
            if ($inputs['rounded'] ?? null) $block_settings['rounded'] = $inputs['rounded'];

            $image = null;            
            if ($request->hasFile('image')) {
                $validator = Validator::make($request->all(), ['image' => 'file|image|max:5120']); // image mime, max 5 MB
                if (!$validator->fails())
                    $image = PostUpload::copyImage($request->file('image'), $oldImage = $request['existing_image'] ?? null, $data = array('module' => $block_module, 'item_id' => null, 'extra_item_id' => null));                    
            }
            $content = array('image' => $image ?? $request['existing_image'] ?? null, 'title' => $request['title'], 'caption' => $request['caption'], 'url' => $request['url']);
            $content = serialize($content);

            // header data
            $header_array = array();
            $header_array = array('add_header' => $inputs['add_header'] ?? null, 'title' =>  $inputs["header_title"] ?? null, 'content' =>  $inputs["header_content"] ?? null);
            $header_content = serialize($header_array);

            PostBlock::where(['id' => $id])->update(['settings' => serialize($block_settings), 'header' => $header_content, 'content' => $content]);
        }

        // Extra content GALLERY        
        if ($type == 'gallery') {
            $block_settings = array('shadow' => null, 'rounded' => null, 'cols' => null, 'masonry_layout' => null, 'masonry_cols' => null, 'masonry_gutter' => null);
            if ($inputs['shadow'] ?? null) $block_settings['shadow'] = $inputs['shadow'];
            if ($inputs['rounded'] ?? null) $block_settings['rounded'] = $inputs['rounded'];
            if ($inputs['cols'] ?? null) $block_settings['cols'] = $inputs['cols'] ?? 4;
            if ($inputs['masonry_layout'] ?? null) $block_settings['masonry_layout'] = $inputs['masonry_layout'];
            if ($inputs['masonry_cols'] ?? null) $block_settings['masonry_cols'] = $inputs['masonry_cols'] ?? 4;
            if ($inputs['masonry_gutter'] ?? null) $block_settings['masonry_gutter'] = $inputs['masonry_gutter'] ?? 0;


            $images_array_key = array();
            $counter_key_images = count(array_filter($_FILES['image']['name']));
            $counter_key_existing = count($inputs["existing_image"] ?? array());
            $counter_key = $counter_key_images + $counter_key_existing;

            $image = null;
            for ($i = 0; $i < $counter_key; $i++) {
                $image = null;

                // delete image (if checkbox is checked)
                if ($request->has('delete_image_' . $i)) {
                    $file_code_to_delete = $inputs['delete_image_file_code_' . $i];
                    delete_image($file_code_to_delete);
                } elseif ($request->hasFile('image')) {

                    if ($file = $request->file('image')[$i] ?? null) {
                        $validator = Validator::make($request->all(), ['image.' . $i => 'file|image|max:2560']); // image mime, max 2.5 MB    
                        if (!$validator->fails()) {
                            $img = PostUpload::storeImage($file, $oldImageCode = $inputs["existing_image"][$i] ?? null, $data = array('module' => $block_module, 'item_id' => null, 'extra_item_id' => null));
                            $image[$i] = $img;
                        }
                    }
                }

                if (!$request->has('delete_image_' . $i)) {
                    if (($image[$i] ?? null) || ($inputs["existing_image"][$i] ?? null))
                        $images_array_key[$i] = array('title' => $inputs["title"][$i], 'image' => $image[$i] ?? $inputs["existing_image"][$i] ?? null, 'caption' => $inputs["caption"][$i], 'position' => $inputs["position"][$i] ?? 1, 'url' => $inputs["url"][$i] ?? null);

                    // regenerate array and sort by position (asc)
                    if (count($images_array_key) > 0) {
                        $position = array_column($images_array_key, 'position');
                        array_multisort($position, SORT_ASC, $images_array_key);
                    }
                }
            }

            $content = serialize($images_array_key);

            // header data
            $header_array = array();
            $header_array = array('add_header' => $inputs['add_header'] ?? null, 'title' =>  $inputs["header_title"] ?? null, 'content' =>  $inputs["header_content"] ?? null);
            $header_content = serialize($header_array);

            PostBlock::where('id', $id)->update(['settings' => serialize($block_settings), 'header' => $header_content, 'content' => $content]);
        }


        // Extra content MAPS       
        if ($type == 'map') {
            $block_settings = array('height' => $inputs['height'] ?? 400, 'zoom' => $inputs['zoom'] ?? 16, 'address' => $inputs['address']);

            // Header data
            $header_array = array();
            $header_array = array('add_header' => $inputs['add_header'] ?? null, 'title' =>  $inputs["header_title"] ?? null, 'content' =>  $inputs["header_content"] ?? null);
            $header_content = serialize($header_array);

            PostBlock::where('id', $id)->update(['settings' => serialize($block_settings), 'header' => $header_content]);
        }

       
        // Extra content BLOCKQUOTE       
        if ($type == 'blockquote') {
            $block_settings = array('shadow' => null, 'use_avatar' => null, 'avatar' => $request['existing_avatar'] ?? null);

            if ($inputs['use_avatar'] ?? null) {
                if ($file = $request->file('avatar')) {
                    $validator = Validator::make($request->all(), ['avatar' => 'file|image|max:2048']); // image mime, max 2 MB    
                    if (!$validator->fails()) {
                        $img = PostUpload::storeImage($file, $oldImageCode = $inputs["existing_avatar"] ?? null, $data = array('module' => $block_module, 'item_id' => null, 'extra_item_id' => null));
                        $block_settings['avatar'] = $img->code;
                    }
                }
            }

            if ($inputs['shadow'] ?? null) $block_settings['shadow'] = $inputs['shadow'];
            if ($inputs['use_avatar'] ?? null) $block_settings['use_avatar'] = $inputs['use_avatar'];

            $content_array = array('source' => $inputs["source"], 'content' => $inputs["content"]);
            $content = serialize($content_array);

            PostBlock::where('id', $id)->update(['settings' => serialize($block_settings), 'content' => $content]);
        }

        
        // CUSTOM
        if ($type == 'custom') {
            $block_settings = array('bg_color' => null);
            if ($inputs['use_custom_bg'] ?? null) $block_settings['bg_color'] = $inputs['bg_color'];
            PostBlock::where('id', $id)->update(['settings' => serialize($block_settings)]);
        }

        

        // ***************************************************
        // Block CONTENT
        // ***************************************************      

        // UPDATE CONTENT
        $content = null;


        // CUSTOM
        if ($type == 'custom') {
            $content = $request['content'];
            PostBlock::where('id', $id)->update(['content' => $content]);
        }

       
    }


     /**
     * Regenerate content blocks
     *
     * @return null
     */
    public static function regenerate_content_blocks($post_id)
    {
        $item = Post::find($post_id);

        if (!$item) return null;

        $blocks = PostBlock::where('post_id', $post_id)
            ->where('hide', 0)
            ->orderBy('position')
            ->select('id', 'type', 'settings')
            ->get()->toArray();

        Post::where('id', $post_id)->update(['blocks' => serialize($blocks)]);

        return;
    }
}
