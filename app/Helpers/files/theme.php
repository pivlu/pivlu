<?php

/**
 * Pivlu - Open source CMS (Content Management System).
 * Pivlu comes with the complete suite of tools that any business, team, or website owner needs.
 * https://pivlu.com
 *
 * Copyright (c) Chimilevschi Iosif-Gabriel
 * LICENSE:
 * Permissions of this strongest copyleft license are conditioned on making available complete source code 
 * of licensed works and modifications, which include larger works using a licensed work, under the same license. 
 * Copyright and license notices must be preserved. Contributors provide an express grant of patent rights. 
 * When a modified version is used to provide a service over a network, the complete source code of the modified version must be made available.
 *    
 * @copyright   Copyright (c) Chimilevschi Iosif-Gabriel
 * @license     https://opensource.org/license/agpl-v3  AGPL-3.0 License.
 * @author      Chimilevschi Iosif-Gabriel <office@pivlu.com>
 * 
 *  DO NOT edit this file manually. All changes will be lost after software update. For custom changes, use templates ans plugins system.
 */

use App\Models\TemplateButton;
use App\Models\Language;
use App\Models\Block;
use App\Models\BlockContent;
use App\Models\Post;


// Get blocks for a specific content (post, page, sidebar, global (top / bottom sections), ....)
if (!function_exists('content_blocks')) {
	function content_blocks($post_id, $show_hidden = null)
	{

		if (!$show_hidden) {
			$blocks = Post::where('id', $post_id)->value('blocks');
			if (!$blocks) return array();
			$blocks = unserialize($blocks);
		} else {
			$blocks = Block::where('post_id', $post_id);

			if (!$show_hidden) $blocks = $blocks->where('blocks.hide', 0);

			$blocks = $blocks->orderBy('position')->get();
			if (!$blocks) return array();
		}

		return $blocks ?? array();
	}
}



// show content block 
if (!function_exists('block')) {
	function block($id)
	{

		$data = array('content' => null, 'content_extra' => null);

		$block = Block::find($id);
		if (!$block) return (object)$data;

		if ($block->hidden == 1) return (object)$data;

		$block_content = BlockContent::where('block_id', $id)->where('lang_id', Language::get_active_language()->id ?? null)->first();

		$data = array('content' => $block_content->content ?? null, 'header' => $block_content->header ?? null);

		return (object)$data;
	}
}


if (!function_exists('button')) {
	function button($id)
	{
		if (!$id) return null;
		$button = TemplateButton::find($id);
		return $button;
	}
}


// create breadcrumb for categories
if (!function_exists('breadcrumb_items')) {
	function breadcrumb_items($categ_id, $module = null)
	{
		if ($module == 'posts' || !$module) {
			$categ = PostCateg::where('id', $categ_id)->first();
			$title = $categ->title;
			$slug = $categ->slug;
		}

		if (!$categ) return array();

		$items[] = array('id' => $categ->id, 'title' => $title, 'slug' => $slug, 'url' => $categ->url, 'active' => $categ->active, 'icon' => $categ->icon, 'count_tree_posts' => $categ->count_tree_posts ?? null, 'count_tree_topics' => $categ->count_tree_topics ?? null, 'count_tree_posts' => $categ->count_tree_posts ?? null);

		$parent_id = $categ->parent_id;
		if ($parent_id) {
			$items = array_merge($items, breadcrumb_items($parent_id, $module));
		}

		$items = json_decode(json_encode($items)); // array to object;
		return ($items);
	}
}


if (!function_exists('breadcrumb')) {
	function breadcrumb($categ_id, $module = null)
	{
		if (!$categ_id)
			return array();
		if (!is_array(breadcrumb_items($categ_id, $module)))
			return array();

		return array_reverse(breadcrumb_items($categ_id, $module));
	}
}
