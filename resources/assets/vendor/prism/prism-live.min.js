// @ts-nocheck
import{$,$$,regexp,loadLanguages}from"./util.js";import{checkShortcut,getLineBounds,beforeCaretIndex,beforeCaret,afterCaretIndex,afterCaret,setCaret,moveCaret,deleteText,matchIndentation,adjustIndentation}from"./editing.js";import{getNode,getOffset}from"./dom.js";import*as env from"./env.js";import*as defaults from"./defaults.js";export default class PrismLive{constructor(e){this.source=e,this.sourceType=e.nodeName.toLowerCase(),this.wrapper=$.create({className:"prism-live",around:this.source}),"textarea"===this.sourceType?(this.textarea=this.source,this.code=document.createElement("code"),this.pre=$.create("pre",{className:this.textarea.className+" no-whitespace-normalization",contents:this.code,before:this.textarea})):(this.pre=this.source,this.pre.classList.add("no-whitespace-normalization"),this.code=$("code",this.pre),this.textarea=$.create("textarea",{className:this.pre.className,value:this.pre.textContent,after:this.pre})),self.all.set(this.textarea,this),self.all.set(this.pre,this),self.all.set(this.code,this),this.pre.classList.add("prism-live"),this.textarea.classList.add("prism-live"),this.source.classList.add("prism-live-source"),self.Incrementable&&new Incrementable(this.textarea),$.bind(this.textarea,{input:e=>this.update(),keyup:e=>{"Enter"==e.key&&(this.insert(this.currentIndent),this.syncScroll())},keydown:e=>{if("Tab"!=e.key||e.altKey)if(self.pairs[e.key]&&!e[env.superKey]){var t=self.pairs[e.key];this.wrapSelection({before:e.key,after:t,outside:!0}),e.preventDefault()}else if(Object.values(self.pairs).includes(e.key))this.selectionStart==this.selectionEnd&&this.textarea.value[this.selectionEnd]==e.key&&(this.selectionStart+=1,this.selectionEnd+=1,e.preventDefault());else for(let t in self.shortcuts)checkShortcut(t,e)&&(self.shortcuts[t].call(this,e),e.preventDefault());else if(e.preventDefault(),this.tabstops&&this.tabstops.length>0)this.moveCaret(this.tabstops.shift());else if(this.hasSelection){var s=this.beforeCaret("\n"),i=e.shiftKey;this.selectionStart-=s.length;var r=adjustIndentation(this.selection,{relative:!0,indentation:i?-1:1});if(this.replace(r),i){var n=regexp.gm`^${this.indent}`.test(s);this.selectionStart+=s.length+1-(i+n)}else{var a=s.length==this.selectionStart;this.selectionStart+=s.length+1+!a}}else{let e=this.beforeCaret()?.match(/\S*$/)?.[0];this.expandSnippet(e)?requestAnimationFrame(()=>this.textarea.dispatchEvent(new InputEvent("input",{bubbles:!0}))):this.insert(this.indent)}},click:e=>{this.getLine(),this.value,this.selectionStart},"click keyup":e=>{(!e.key||e.key.lastIndexOf("Arrow")>-1)&&(this.tabstops=null)}}),this.textarea.addEventListener("scroll",this,{passive:!0}),$.bind(window,{resize:e=>this.syncStyles()}),requestAnimationFrame(()=>{this.syncStyles();var e=getComputedStyle(this.source);this.pre.style.height=this.source.style.height||e.getPropertyValue("--height"),this.pre.style.maxHeight=this.source.style.maxHeight||e.getPropertyValue("--max-height"),this.textarea.spellcheck=this.source.spellcheck||e.getPropertyValue("--spellcheck")}),this.update(),this.lang=(this.code.className.match(/lang(?:uage)?-(\w+)/i)||[,])[1],this.observer=new MutationObserver(e=>{document.activeElement!==this.textarea&&(this.textarea.value=this.pre.textContent)}),this.observe(),this.source.dispatchEvent(new CustomEvent("prism-live-init",{bubbles:!0,detail:this}))}handleEvent(e){"scroll"===e.type&&this.syncScroll()}observe(){return this.observer&&this.observer.observe(this.pre,{childList:!0,subtree:!0,characterData:!0})}unobserve(){this.observer&&(this.observer.takeRecords(),this.observer.disconnect())}expandSnippet(e){if(!e)return!1;var t=this.context;if(e in t.snippets||e in self.snippets)var s=t.snippets[e]||self.snippets[e];else if(t.snippets.custom)s=t.snippets.custom.call(this,e);if(s){for(var i,r=[],n=[],a=s;i=self.CARET_INDICATOR.exec(a);)r.push(i.index+1),n.push(a.slice(0,i.index+i[1].length)),a=a.slice(i.index+i[0].length),self.CARET_INDICATOR.lastIndex=0;n.push(a),n=n.join(""),r.length>0&&(r[0]-=n.length),this.delete(e),this.insert(n,{matchIndentation:!0}),this.tabstops=r,this.moveCaret(this.tabstops.shift())}return!!s}get selectionStart(){return this.textarea.selectionStart}set selectionStart(e){this.textarea.selectionStart=e}get selectionEnd(){return this.textarea.selectionEnd}set selectionEnd(e){this.textarea.selectionEnd=e}get hasSelection(){return this.selectionStart!=this.selectionEnd}get selection(){return this.value.slice(this.selectionStart,this.selectionEnd)}get value(){return this.textarea.value}set value(e){this.textarea.value=e}get indent(){return this.value.match(/^[\t ]+/m)?.[0]??defaults.indent}get currentIndent(){let e=this.value.slice(0,this.selectionStart-1);return e.match(/^[\t ]*/gm)?.at(-1)??""}get currentLanguage(){var e=this.getNode();e=e?e.parentNode:this.code;let t=e.closest('[class*="language-"]')?.className.match(/language-(\w+)/)?.[1];return self.aliases[t]||t}get context(){var e=this.currentLanguage;return self.languages[e]||self.languages.DEFAULT}setSelection(e,t){e&&"object"==typeof e&&(e.start||e.end)&&(t=e.end,e=e.start);let s=this.selectionStart,i=this.selectionEnd;void 0!==e&&(this.selectionStart=e),void 0!==t&&(this.selectionEnd=t),this.selectionStart===this.selectionEnd||s===this.selectionStart&&i===this.selectionEnd||this.textarea.dispatchEvent(new Event("select",{bubbles:!0}))}update(e){var t=this.value;/\n$/.test(this.value)&&(t+="â€‹"),!e&&this.code.textContent===t&&$(".token",this.code)||(this.unobserve(),this.code.textContent=t,Prism.highlightElement(this.code),this.observe())}syncStyles(){var e=getComputedStyle(this.pre);this.textarea.style.caretColor=e.color;var t=/^(font|lineHeight)|[tT]abSize/gi;for(var s in e)e[s]&&s in this.textarea.style&&t.test(s)&&(this.wrapper.style[s]=e[s],this.textarea.style[s]=this.pre.style[s]="inherit");this.textarea.style["padding-left"]=e["padding-left"],this.update()}syncScroll(){0===this.pre.clientWidth&&0===this.pre.clientHeight||(this.pre.scrollTop=this.textarea.scrollTop,this.pre.scrollLeft=this.textarea.scrollLeft)}beforeCaretIndex(e=""){return beforeCaretIndex(e,this)}afterCaretIndex(e=""){return afterCaretIndex(e,this)}beforeCaret(e=""){return beforeCaret(e,this)}getLine(){return getLineBounds(this)}afterCaret(e=""){return afterCaret(e,this)}setCaret(e){return setCaret(e,this)}moveCaret(e){return moveCaret(e,this)}insert(e,{index:t}={}){if(e)if(this.textarea.focus(),void 0===t)this.replace(e);else{var s=this.selectionStart,i=this.selectionEnd;this.selectionStart=this.selectionEnd=t,this.replace(e),this.setSelection(s+(t<s?e.length:0),i+(t<=i?e.length:0))}}replace(e){var t=this.hasSelection;this.insertText(e),t&&this.setSelection({start:this.selectionEnd-e.length})}set(e,{start:t,end:s}={}){var i=this.selectionStart,r=this.selectionEnd;this.setSelection(t,s),this.insertText(e),this.setSelection(i,r)}insertText(e){if(e)return document.execCommand("insertText",!1,e)}wrap({before:e,after:t,start:s=this.selectionStart,end:i=this.selectionEnd}={}){var r=this.selectionStart,n=this.selectionEnd,a=this.value.slice(s,i);this.set(e+a+t,{start:s,end:i}),r>s&&(r+=e.length),n>s&&(n+=e.length),r>i&&(r+=t.length),n>i&&(n+=t.length),this.setSelection(r,n)}wrapSelection(e={}){var t=this.hasSelection;this.replace(e.before+this.selection+e.after),t?e.outside&&(this.selectionStart+=e.before.length,this.selectionEnd-=e.after.length):this.moveCaret(-e.after.length)}toggleComment(){var e=this.context.comments,t=this.getNode().parentNode.closest(".token.comment");if(t){var s=this.getOffset(t),i=t.textContent;if(e.singleline&&0===i.indexOf(e.singleline)){var r=s+i.length;this.set(this.value.slice(s+e.singleline.length,r),{start:s,end:r}),this.moveCaret(-e.singleline.length)}else{e=e.multiline||e;r=s+i.length-e[1].length;this.set(this.value.slice(s+e[0].length,r),{start:s,end:r+e[1].length})}}else this.hasSelection?(e=e.multiline||e,this.wrapSelection({before:e[0],after:e[1]})):(e=e.singleline?[e.singleline,""]:e.multiline||e,r=this.afterCaretIndex("\n"),this.wrap({before:e[0],after:e[1],start:this.beforeCaretIndex("\n")+1,end:r<0?this.value.length:r}))}duplicateContent(){var e=this.beforeCaret("\n"),t=this.afterCaret("\n"),s=e+this.selection+t;this.insert(s,{index:this.selectionStart-e.length})}delete(e,{forward:t,pos:s}={}){let{selectionStart:i,selectionEnd:r}=deleteText(e,{forward:t,pos:s,selectionStart:this.selectionStart,selectionEnd:this.selectionEnd});this.setSelection(i,r)}getNode(e=this.selectionStart,t=this.code){return getNode(e,t)}getOffset(e){return getOffset(e,this.code)}static registerLanguage(e,t,s=self.languages.DEFAULT){return Object.setPrototypeOf(t,s),self.languages[e]=t}static create(e,...t){let s=self.all.get(e);return s||(s=new self(e)),s}}let self=PrismLive;Prism.Live??=PrismLive,Object.assign(self,{all:new WeakMap,DEFAULT_INDENT:defaults.indent,CARET_INDICATOR:/(^|[^\\])\$(\d+)/g,snippets:{test:"Snippets work!"},pairs:{"(":")","[":"]","{":"}",'"':'"',"'":"'","`":"`"},shortcuts:{"Cmd + /":function(){this.toggleComment()},"Ctrl + Shift + D":function(){this.duplicateContent()}},languages:{DEFAULT:{comments:{multiline:["/*","*/"]},snippets:{}}},aliases:(()=>{var e={},t=new WeakMap(Object.entries(Prism.languages).map(e=>e.reverse()).reverse());for(var s in Prism.languages){var i=Prism.languages[s];"function"!=typeof i&&(e[s]=t.get(i))}return e})()});export const dependencies=[$.load(new URL("prism-live.css",import.meta.url))];let url=new URL(import.meta.url),urlParams=url.searchParams;if(urlParams.has("load")){let e=urlParams.get("load");if(null!==e){let t=loadLanguages(e,PrismLive);dependencies.push(...t)}}export const ready=Promise.all(dependencies);self.ready=ready,$$(":not(.prism-live) > textarea.prism-live, :not(.prism-live) > pre.prism-live").forEach(e=>self.create(e));