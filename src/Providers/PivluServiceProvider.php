<?php

/**
 * Pivlu - Open source CMS (Content Management System).
 * Pivlu comes with the complete suite of tools that any business, team, or website owner needs.
 * https://pivlu.com
 *
 * Copyright (c) Chimilevschi Iosif-Gabriel
 * LICENSE:
 * Permissions of this strongest copyleft license are conditioned on making available complete source code 
 * of licensed works and modifications, which include larger works using a licensed work, under the same license. 
 * Copyright and license notices must be preserved. Contributors provide an express grant of patent rights. 
 * When a modified version is used to provide a service over a network, the complete source code of the modified version must be made available.
 *    
 * @copyright   Copyright (c) Chimilevschi Iosif-Gabriel
 * @license     https://opensource.org/license/agpl-v3  AGPL-3.0 License.
 * @author      Chimilevschi Iosif-Gabriel <office@pivlu.com>
 * 
 *  DO NOT edit this file manually. All changes will be lost after software update. For custom changes, use templates ans plugins system.
 */

namespace Pivlu\Providers;

use Illuminate\Support\ServiceProvider;
use Illuminate\Support\Facades\Route;
use Illuminate\Pagination\Paginator;
use Illuminate\Support\Facades\Gate;
use Illuminate\Support\Facades\Schema;

use Pivlu\Providers\FortifyServiceProvider;
use Pivlu\Providers\ViewServiceProvider;
use Pivlu\Console\Commands\InstallCommand;
use Pivlu\Console\Commands\UpdateCommand;
use Pivlu\Console\Commands\CreateSamplePostsCommand;
use Pivlu\Http\Middleware\WebsiteMiddleware;
use Pivlu\Http\Middleware\LoggedIsInternalMiddleware;
use Pivlu\Http\Middleware\LoggedMiddleware;
use Pivlu\Http\Middleware\LoggedIsAdminMiddleware;
use Pivlu\Http\Middleware\LoggedIsRegisteredMiddleware;
use App;

class PivluServiceProvider extends ServiceProvider
{

   public function boot()
   {
      // Check if app is installed (if not in console)
      if (!App::runningInConsole()) {
         if (!Schema::hasTable('pivlu_config')) {
            echo ('Pivlu is not installed!');
            exit;
         }
      }

      // Implicitly grant "admin" role all permission checks using can()
      Gate::before(function ($user, $ability) {
         if ($user->hasRole('admin')) {
            return true;
         }
      });

      Paginator::useBootstrapFive();

      // Register our package's middlewares.
      $this->app['router']->aliasMiddleware('website', WebsiteMiddleware::class);
      $this->app['router']->aliasMiddleware('logged', LoggedMiddleware::class);
      $this->app['router']->aliasMiddleware('logged_is_internal', LoggedIsInternalMiddleware::class);
      $this->app['router']->aliasMiddleware('logged_is_admin', LoggedIsAdminMiddleware::class);
      $this->app['router']->aliasMiddleware('logged_is_registered', LoggedIsRegisteredMiddleware::class);
     
      // Register routes.
      $this->registerRoutes();

      // Register views.
      $this->loadViewsFrom(__DIR__ . '/../../resources/views', 'pivlu');

      // Publish assets.
      $this->publishes([__DIR__ . '/../../resources/assets/' => public_path('assets')], 'assets'); // <- The tag ("assets") is defined here will be used in `php artisan vendor:publish --tag=assets` command.

      // Publish migrations.
      $this->publishes([__DIR__ . '/../../database/migrations' => database_path('migrations')], 'migrations');  // <- The tag ("migrations") is defined here will be used in `php artisan vendor:publish --tag=migrations` command.

      if ($this->app->runningInConsole()) {
         // Register commands.
         $this->commands([
            InstallCommand::class,
            UpdateCommand::class,
            CreateSamplePostsCommand::class,
         ]);
      }
   }


   public function register()
   {
      $this->app->register(FortifyServiceProvider::class);
      $this->app->register(ViewServiceProvider::class);

      // Merge configuration.
      $this->mergeConfigFrom(__DIR__ . '/../../config/pivlu.php', 'pivlu');
   }

   protected function registerRoutes()
   {
      Route::group($this->routeAdminConfiguration(), function () {
         $this->loadRoutesFrom(__DIR__ . '/../../routes/admin.php');
      });

      Route::group($this->routeWebConfiguration(), function () {
         $this->loadRoutesFrom(__DIR__ . '/../../routes/web.php');
      });

      Route::group($this->routeRegisteredConfiguration(), function () {
        //
      });
   }

   protected function routeAdminConfiguration()
   {
      return [
         'middleware' => ['web', 'auth', 'verified', 'logged', 'logged_is_internal'],
          'prefix' => 'account/admin/',      
      ];
   }

   protected function routeWebConfiguration()
   {
      return [
         'middleware' => ['web', 'logged', 'website'],
      ];
   }

   protected function routeRegisteredConfiguration()
   {
      return [
         'middleware' => ['web', 'auth', 'verified', 'logged', 'logged_is_registered'],
          'prefix' => 'account/user/',      
      ];
   }
}
