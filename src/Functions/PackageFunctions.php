<?php

/**
 * Pivlu - Open source CMS (Content Management System).
 * Pivlu comes with the complete suite of tools that any business, team, or website owner needs.
 * https://pivlu.com
 *
 * Copyright (c) Chimilevschi Iosif-Gabriel
 * LICENSE:
 * Permissions of this strongest copyleft license are conditioned on making available complete source code 
 * of licensed works and modifications, which include larger works using a licensed work, under the same license. 
 * Copyright and license notices must be preserved. Contributors provide an express grant of patent rights. 
 * When a modified version is used to provide a service over a network, the complete source code of the modified version must be made available.
 *    
 * @copyright   Copyright (c) Chimilevschi Iosif-Gabriel
 * @license     https://opensource.org/license/agpl-v3  AGPL-3.0 License.
 * @author      Chimilevschi Iosif-Gabriel <office@pivlu.com>
 * 
 *  DO NOT edit this file manually. All changes will be lost after software update. For custom changes, use templates ans plugins system.
 */

namespace Pivlu\Functions;

use Illuminate\Support\Str;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\Route;

use Pivlu\Models\PostType;
use Pivlu\Models\PostTypeContent;
use Pivlu\Models\PostTypeTaxonomy;
use Pivlu\Models\PostTypeTaxonomyContent;
use Pivlu\Models\Language;
use Pivlu\Models\Theme;
use Pivlu\Models\Package;
use Pivlu\Functions\HelperFunctions;

class PackageFunctions
{
    public static function install_package($package)
    {
        $composer_json_path = base_path('/vendor/' . $package) . '/composer.json';
        $package_json_path = base_path('/vendor/' . $package) . '/package.json';

        if (!file_exists($composer_json_path)) {
            exit('"composer.json" file not found in your package:' . $composer_json_path);
        }

        if (!file_exists($package_json_path)) {
            exit('"package.json" file not found in your package:' . $package_json_path);
        }

        $composer_json_content = file_get_contents($composer_json_path);
        $package_name = $composer_json_path ? json_decode($composer_json_content, true)['name'] ?? 'default' : 'default';
        $package_description = $package_json_path ? json_decode(file_get_contents($package_json_path), true)['description'] ?? null : null;
        $package_provider = $composer_json_path ? json_decode($composer_json_content, true)['extra']['laravel']['providers'] ?? 'default' : 'default';
        $vendor_name = explode('/', $package_name)[0] ?? null;
        $package_name = explode('/', $package_name)[1] ?? null;
        $package_provider = is_array($package_provider) ? $package_provider[0] : [$package_provider];

        $package_json_content = file_get_contents($package_json_path);
        $package_has_theme = json_decode($package_json_content, true)['has_theme'] ?? false;
        $package_has_plugin = json_decode($package_json_content, true)['has_plugin'] ?? false;

        // Create package entry.
        $packageObject = Package::updateOrCreate(
            [
                'vendor_name' => $vendor_name,
                'package_name' => $package_name,
            ],
            [
                'name' => ucfirst(str_replace('-', ' ', $vendor_name)) . ' ' . ucfirst(str_replace('-', ' ', $package_name)),
                'code' => HelperFunctions::generateRandomInteger(16),
                'description' => $package_description ?? null,
                'has_theme' => $package_has_theme ? 1 : 0,
                'has_plugin' => $package_has_plugin ? 1 : 0,
            ]
        );

        if ($package_has_theme) {
            $themeObject = Theme::where('vendor_name', $vendor_name)->where('package_name', $package_name)->first();
            if (!$themeObject)
                $themeObject = Theme::create(
                    [
                        'vendor_name' => $vendor_name,
                        'package_name' => $package_name,
                        'name' => ucfirst(str_replace('-', ' ', $vendor_name)) . ' ' . ucfirst(str_replace('-', ' ', $package_name)),
                        'code' => HelperFunctions::generateRandomInteger(16),
                        'description' => $package_description ?? null,
                        'package_id' => $packageObject->id,
                        'views_hint' => $vendor_name . '.' . $package_name,
                    ]
                );
                else {
                // Update existing theme    
                $themeObject->update(
                    [
                        'name' => ucfirst(str_replace('-', ' ', $vendor_name)) . ' ' . ucfirst(str_replace('-', ' ', $package_name)),
                        'description' => $package_description ?? null,
                        'package_id' => $packageObject->id,
                        'views_hint' => $vendor_name . '.' . $package_name,
                    ]
                );
            }

            // create theme css file IF NOT EXISTS (do not overwrite if exists)
            $theme_css_file = public_path('custom/themes/' . $themeObject->code . '.css');
            if (!file_exists($theme_css_file)) {
                $css_file = fopen($theme_css_file, "w");
                $write = " ";
                fwrite($css_file, $write);
                fclose($css_file);

                ThemeFunctions::generate_theme_css($themeObject->code);
            }
        }

        return;
    }


    public static function create_post_type(string $type, array $args = array())
    {

        $type =  Str::slug($type, '-');
        $type = substr($type, 0, 20);

        if (PostType::where('type', $type)->exists()) {
            return response()->json([
                'status' => 'error',
                'error' => 'exists',
            ]);
        }

        $show_in_admin_menu = $args['show_in_admin_menu'] ?? 1;
        $admin_menu_icon = $args['admin_icon'] ?? '<i class="bi bi-file-text"></i>';
        $name = $args['name'] ?? $type;
        $slug = $args['slug'] ?? $type;
        $labels = $args['labels'] ?? [];

        $post_type = PostType::create([
            'type' => $type,
            'show_in_admin_menu' => $show_in_admin_menu,
            'admin_menu_icon' => $admin_menu_icon,
            'core' => 0,
            'active' => 1,
        ]);

        $labels = [
            "singular" => $labels['singular'] ?? $type,
            "plural" => $labels['plural'] ?? $type,
            "create"  => $labels['create'] ?? "Create item",
            "update"  => $labels['update'] ?? "Update item",
            "delete" => $labels['delete'] ?? "Delete item",
            "all" => $labels['all'] ?? "All item",
            "search" => $labels['search'] ?? "Search items",
        ];

        PostTypeContent::create([
            'post_type_id' => $post_type->id,
            'lang_id' => Language::get_default_language()->id,
            'name' => $name,
            'slug' => $slug,
            'labels' => json_encode($docs_labels, JSON_UNESCAPED_UNICODE),
        ]);

        return response()->json([
            'status' => 'ok',
        ]);
    }



    public static function create_post_type_taxonomy(string $post_type, string $name, array $args = array())
    {

        if (! $name)
            return response()->json([
                'status' => 'error',
                'error' => 'no_name',
            ]);

        $postTypeObj = PostType::where('type', $post_type)->first();

        $name = substr($name, 0, 25);

        if (! $post_type || $name)
            return response()->json([
                'status' => 'error',
                'error' => 'no_post_type',
            ]);

        $hierarchical = $args['hierarchical'] ?? 0;
        $position = $args['position'] ?? 1;
        $admin_filter = $args['admin_filter'] ?? 1;
        $slug = Str::slug($args['slug'] ?? $name, '-');
        $labels = $args['labels'] ?? [];

        $post_type_taxonomy = PostTypeTaxonomy::create([
            'post_type_id' => $postTypeObj->id,
            'hierarchical' => $hierarchical,
            'active' => 1,
            'position' => $position,
            'admin_filter' => $admin_filter
        ]);

        $labels = [
            "singular" => $labels['singular'] ?? $name,
            "plural" => $labels['plural'] ?? (($hierarchical == 1) ? 'All categories' : 'All tags'),
            "create" => $labels['create'] ?? (($hierarchical == 1) ? 'Create category' : 'Create tag'),
            "update" => $labels['update'] ?? (($hierarchical == 1) ? 'Update category' : 'Update tag'),
            "delete" => $labels['delete'] ?? (($hierarchical == 1) ? 'Delete category' : 'Delete tag'),
            "all" => $labels['all'] ?? (($hierarchical == 1) ? 'All categories' : 'All tags'),
            "search" => $labels['search'] ?? (($hierarchical == 1) ? 'Search categories' : 'Search tags'),
            "popular" => $labels['popular'] ?? (($hierarchical == 1) ? 'Popular categories' : 'Popular tags'),
        ];

        PostTypeTaxonomyContent::create([
            'post_type_taxonomy_id' => $post_type_taxonomy->id,
            'lang_id' => Language::get_default_language()->id,
            'name' => $name,
            'slug' => $slug,
            'labels' => json_encode($taxonomy_labels, JSON_UNESCAPED_UNICODE),
        ]);

        return response()->json([
            'status' => 'ok',
        ]);
    }


    public static function routeAdminConfiguration($vendor_name, $package_name)
    {
        return [
            'middleware' => ['web', 'auth', 'verified', 'logged', 'logged_is_internal'],
            'prefix' => 'account/admin/' . $vendor_name . '/' . $package_name . '/',
            'as' => $vendor_name . '.' . $package_name . '.',
        ];
    }

    public static function routeWebConfiguration($vendor_name, $package_name)
    {
        return [
            'middleware' => ['web', 'logged', 'website'],
            'as' => $vendor_name . '.' . $package_name . '.',
        ];
    }

    public static function routeRegisteredConfiguration($vendor_name, $package_name)
    {
        return [
            'middleware' => ['web', 'auth', 'verified', 'logged', 'logged_is_registered'],
            'prefix' => 'account/user/' . $vendor_name . '/' . $package_name . '/',
            'as' => $vendor_name . '.' . $package_name . '.',
        ];
    }


    public static function init($package_root_path)
    {
        if (!Schema::hasTable('pivlu_config')) {
            exit('Pivlu is not installed!');
        }

        $composer_json_path = $package_root_path . 'composer.json';

        if (!file_exists($composer_json_path)) {
            exit('"composer.json" file not found in your package!');
        }

        $json_content = file_get_contents($composer_json_path);
        $package_name = $composer_json_path ? json_decode($json_content, true)['name'] ?? 'default' : 'default';
        $package_provider = $composer_json_path ? json_decode($json_content, true)['extra']['laravel']['providers'] ?? 'default' : 'default';
        $vendor_name = explode('/', $package_name)[0] ?? null;
        $package_name = explode('/', $package_name)[1] ?? null;

        $package_provider = is_array($package_provider) ? $package_provider[0] : [$package_provider];
        $package_root_path = rtrim($package_root_path, '/') . '/';
        $data = ['vendor_name' => $vendor_name, 'package_name' => $package_name, 'package_provider' => $package_provider ?? null, 'package_root_path' => $package_root_path];

        return (object)$data;
    }


    public static function registerRoutes($package)
    {
        //dd($package);
        Route::group(PackageFunctions::routeAdminConfiguration($package->vendor_name, $package->package_name), function () {
            $this->loadRoutesFrom(__DIR__ . '/../../routes/admin.php');
        });
        Route::group(PackageFunctions::routeWebConfiguration($package->vendor_name, $package->package_name), function () {
            $this->loadRoutesFrom(__DIR__ . '/../../routes/web.php');
        });
    }
}
