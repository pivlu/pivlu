<?php

/**
 * Pivlu - Open source CMS (Content Management System).
 * Pivlu comes with the complete suite of tools that any business, team, or website owner needs.
 * https://pivlu.com
 *
 * Copyright (c) Chimilevschi Iosif-Gabriel
 * LICENSE:
 * Permissions of this strongest copyleft license are conditioned on making available complete source code 
 * of licensed works and modifications, which include larger works using a licensed work, under the same license. 
 * Copyright and license notices must be preserved. Contributors provide an express grant of patent rights. 
 * When a modified version is used to provide a service over a network, the complete source code of the modified version must be made available.
 *    
 * @copyright   Copyright (c) Chimilevschi Iosif-Gabriel
 * @license     https://opensource.org/license/agpl-v3  AGPL-3.0 License.
 * @author      Chimilevschi Iosif-Gabriel <office@pivlu.com>
 * 
 *  DO NOT edit this file manually. All changes will be lost after software update. For custom changes, use templates ans plugins system.
 */

namespace Pivlu\Console\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Str;
use Pivlu\Models\User;
use Pivlu\Models\Post;
use Pivlu\Models\PostType;
use Pivlu\Models\Block;
use Pivlu\Models\BlockType;
use Pivlu\Models\PostContent;
use Pivlu\Models\BlockContent;
use Pivlu\Models\Language;

use Illuminate\Database\Eloquent\Factories\Factory;

class CreateSamplePostsCommand extends Command
{


    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'pivlu:create-sample-posts';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Create sample posts';

    /**
     * Execute the console command.
     *
     * @return mixed
     */
    public function handle()
    {

        $this->line('Create sample posts');

        $number_of_posts = $this->ask('Input the number of fake posts to be created: ', '6', ['required', 'min:1', 'max:48']);

        $number_of_posts = (int)$number_of_posts;
        if (! ($number_of_posts > 1 && $number_of_posts <= 24)) $number_of_posts = 6;

        // Admin user_id
        $admin_user_id = User::where(['role' => 'admin'])->orderByDesc('id')->value('id');

        // id for post type
        $post_type_post = PostType::where(['type' => 'post'])->first();

        // id for editor block   
        $editor_block_type = BlockType::where(['type' => 'editor'])->first();

        for ($i = 0; $i < $number_of_posts; $i++) {

            $title = fake()->sentence(12);
            $summary = fake()->paragraph();
            $content = fake()->paragraphs(6, true);

            $fake_post = Post::create([
                'post_type_id' => $post_type_post->id,
                'status' => 'published',
                'user_id' => $admin_user_id,
                'is_sample' => 1,
            ]);

            PostContent::create([
                'lang_id' => Language::get_default_language()->id,
                'post_id' => $fake_post->id,
                'title' => $title,
                'summary' => $summary,
                'slug' => Str::slug($title, '-'),
            ]);

            $post_block = Block::create([
                'type_id' => $editor_block_type->id,
                'post_id' => $fake_post->id,
                'label' => 'Fake post',
                'position' => 1,
                'user_id' => $admin_user_id
            ]);

            BlockContent::create([
                'block_id' => $post_block->id,
                'lang_id' => Language::get_default_language()->id,
                'content' => $content,
            ]);

            $fake_post->update(['blocks' => serialize(['id' => $post_block->id, 'type_id' =>  $editor_block_type->id, 'type' => 'editor'])]);
        }


        $this->info('The fake posts was created!');
    }
}
