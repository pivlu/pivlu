<?php

/**
 * Pivlu - Open source CMS (Content Management System).
 * Pivlu comes with the complete suite of tools that any business, team, or website owner needs.
 * https://pivlu.com
 *
 * Copyright (c) Chimilevschi Iosif-Gabriel
 * LICENSE:
 * Permissions of this strongest copyleft license are conditioned on making available complete source code 
 * of licensed works and modifications, which include larger works using a licensed work, under the same license. 
 * Copyright and license notices must be preserved. Contributors provide an express grant of patent rights. 
 * When a modified version is used to provide a service over a network, the complete source code of the modified version must be made available.
 *    
 * @copyright   Copyright (c) Chimilevschi Iosif-Gabriel
 * @license     https://opensource.org/license/agpl-v3  AGPL-3.0 License.
 * @author      Chimilevschi Iosif-Gabriel <office@pivlu.com>
 * 
 *  DO NOT edit this file manually. All changes will be lost after software update. For custom changes, use templates ans plugins system.
 */

namespace Pivlu\Http\Controllers\Admin;

use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\Validator;
use Pivlu\Models\Block;
use Pivlu\Models\BlockType;
use Pivlu\Models\Page;
use Pivlu\Models\PostCateg;
use Pivlu\Models\ThemeLayout;
use Pivlu\Models\ThemeLayoutBlock;
use Pivlu\Models\Language;
use Auth;

class ThemeLayoutController extends Controller
{

    /**
     * Show all resources
     */
    public function index()
    {
        $layouts = ThemeLayout::orderBy('label')->paginate(25);

        return view('pivlu::admin.index', [
            'view_file' => 'admin.theme.layouts.index',
            'active_menu' => 'website',
            'active_submenu' => 'themes',
            'nav_tab' => 'layouts',
            'layouts' => $layouts,
        ]);
    }


    /**
     * Create resource
     */
    public function store(Request $request)
    {

        $validator = Validator::make($request->all(), [
            'label' => 'required',
        ]);

        if ($validator->fails()) return redirect(route('admin.theme.layouts'))->withErrors($validator)->withInput();

        if (ThemeLayout::where('label', $request->label)->exists()) return redirect(route('admin.theme.layouts'))->with('error', 'duplicate');

        ThemeLayout::create([
            'label' => $request->label,
            'has_top_section' => $request->has('has_top_section') ? 1 : 0,
            'has_bottom_section' => $request->has('has_bottom_section') ? 1 : 0,
            'sidebar' => $request->has('sidebar') ? $request->sidebar_position : null,
            'bg_color_top' => $request->has('use_bg_color_top') ? $request->bg_color_top : null,
            'bg_color_bottom' => $request->has('use_bg_color_bottom') ? $request->bg_color_bottom : null,
            'bg_color_sidebar' => $request->has('use_bg_color_sidebar') ? $request->bg_color_sidebar : null,
        ]);

        return redirect(route('admin.theme.layouts'))->with('success', 'created');
    }


    /**
     * Update resource
     */
    public function update(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'label' => 'required',
        ]);

        if ($validator->fails()) return redirect(route('admin.theme.layouts'))->withErrors($validator)->withInput();

        if (ThemeLayout::where('label', $request->label)->where('id', '!=', $request->id)->exists()) return redirect(route('admin.theme.layouts'))->with('error', 'duplicate');

        ThemeLayout::where('id', $request->id)->update([
            'label' => $request->label,
            'has_top_section' => $request->has('has_top_section') ? 1 : 0,
            'has_bottom_section' => $request->has('has_bottom_section') ? 1 : 0,
            'sidebar' => $request->has('sidebar') ? $request->sidebar_position : null,
            'bg_color_top' => $request->has('use_bg_color_top') ? $request->bg_color_top : null,
            'bg_color_bottom' => $request->has('use_bg_color_bottom') ? $request->bg_color_bottom : null,
            'bg_color_sidebar' => $request->has('use_bg_color_sidebar') ? $request->bg_color_sidebar : null,
        ]);

        return redirect(route('admin.theme.layouts'))->with('success', 'updated');
    }


    /**
     * Show resource
     */
    public function show(Request $request)
    {
        $layout = ThemeLayout::find($request->id);
        if (!$layout) return redirect(route('admin.theme.layouts'));

        return view('pivlu::admin.index', [
            'view_file' => 'admin.theme.layouts.content',
            'active_menu' => 'website',
            'active_submenu' => 'themes',
            'nav_tab' => 'layouts',
            'item' => $layout,
            'block_types' => BlockType::get_block_types()->where('allow_in_footer', 1),
        ]);
    }


    /**
     * Update blocks content
     */
    public function update_content(Request $request)
    {
        // disable action in demo mode:
        if (config('app.demo_mode')) return redirect(route('admin'))->with('error', 'demo');

        if (!check_access('developer')) return redirect(route('admin'));

        $item = ThemeLayout::find($request->id);
        if (!$item) return redirect(route('admin.theme.layouts'));

        if (!$request->type) return redirect(route('admin.theme.layouts.show', ['id' => $request->id]));

        $last_pos = ThemeLayoutBlock::where('layout', $request->layout)->where('layout_id', $request->id)->orderByDesc('position')->value('position');
        $position = ($last_pos ?? 0) + 1;

        $block = ThemeLayoutBlock::create([
            'label' => $request->label,
            'layout_id' => $request->id,
            'type' => $request->type,
            'layout' => $request->layout,
            'position' => $position,
            'created_by_user_id' =>  Auth::user()->id
        ]);

        return redirect(route('admin.theme.layouts.block', ['id' => $block->id]));
    }


    /**
     * Remove the specified resource
     */
    public function destroy(Request $request)
    {
        // disable action in demo mode:
        if (config('app.demo_mode')) return redirect(route('admin'))->with('error', 'demo');

        if (!check_access('developer')) return redirect(route('admin'));

        $layout = ThemeLayout::find($request->id);
        if (!$layout) return redirect(route('admin.theme.layouts'));

        // delete layout content blocks
        $layout_blocks = ThemeLayoutBlock::where('layout_id', $request->id)->get();
        foreach ($layout_blocks as $layout_block) {
            ThemeLayoutBlockContent::where('block_id', $layout_block->id)->delete();
        }

        Page::where('layout_id', $request->id)->update(['layout_id' => null]);
        PostCateg::where('layout_id', $request->id)->update(['layout_id' => null]);
        ThemeLayoutBlock::where('layout_id', $request->id)->delete();
        ThemeLayout::where('id', $request->id)->delete();

        return redirect(route('admin.theme.layouts'))->with('success', 'deleted');
    }


    /**
     * Remove the specified block content
     */
    public function delete_content(Request $request)
    {
        // disable action in demo mode:
        if (config('app.demo_mode')) return redirect(route('admin'))->with('error', 'demo');

        if (!check_access('developer')) return redirect(route('admin'));

        $layout = ThemeLayout::find($request->id);
        if (!$layout) return redirect(route('admin.theme.layouts'));

        ThemeLayoutBlock::where('id', $request->block_id)->delete();

        return redirect(route('admin.theme.layouts.show', ['id' => $request->id]))->with('success', 'deleted');
    }


    /**
     * Ajax sortable footer blocks
     */
    public function sortable(Request $request)
    {
        $i = 0;
        $records = $request->all();

        foreach ($records['item'] as $key => $value) {
            ThemeLayoutBlock::where('layout_id', $request->id)->where('layout', $request->layout)->where('id', $value)->update(['position' => $i]);
            $i++;
        }
    }


    /**
     * Show block
     */
    public function block(Request $request)
    {
        if (!check_access('developer')) return redirect(route('admin'));

        if (!check_access('developer')) return redirect(route('admin'));

        $block = ThemeLayoutBlock::find($request->id);
        if (!$block) return redirect(route('admin.theme.layouts'));

        // Retrieve block content for each language.
        $content_langs = Language::where('status', '!=', 'disabled')->with(['layout_block_content' => function ($query) use ($request) {
            $query->where('block_id', $request->id);
        }])->orderByDesc('is_default')->get();

        /*
        $langs = DB::table('sys_lang')
            ->select(
                'sys_lang.*',
                DB::raw('(SELECT content FROM sys_layout_blocks_content WHERE sys_layout_blocks_content.lang_id = sys_lang.id AND block_id = ' . $block->id . ') as block_content'),
                DB::raw('(SELECT header FROM sys_layout_blocks_content WHERE sys_layout_blocks_content.lang_id = sys_lang.id AND block_id = ' . $block->id . ') as block_header')
            )
            ->where('status', '!=', 'disabled')
            ->orderByDesc('is_default')
            ->orderBy('status')
            ->get();
        */

        // posts categories (used in posts block)
        //$posts_categories = PostCateg::where('active', 1)->orderBy('title')->get();

        // forms (used in form block)
        //$forms = Form::where('active', 1)->orderBy('label')->get();

        if ($request->referer) $referer = $request->referer;
        else $referer = request()->headers->get('referer');

        return view('pivlu::admin.index', [
            'view_file' => 'blocks.update-' . $block->type,
            'active_menu' => 'website',
            'active_submenu' => 'themes',
            'nav_tab' => 'layouts',
            'block_module' => 'layout',
            'block' => $block,
            'content_langs' => $content_langs,
            'langs' => Language::get_languages(),
            'referer' => $referer,

            'font_sizes' => Template::template_font_sizes(),
            'buttons' => TemplateButton::get(),
            'styles' => TemplateStyle::orderBy('label')->get(),

            'posts_categories' => $posts_categories ?? null, // posts categories (used in posts block)
            'forms' => $forms ?? null, // forms (used in form block)
            'is_layout_block' => 1
        ]);
    }


    /**
     * Update block    
     */
    public function block_update(Request $request)
    {
        if (!check_access('developer')) return redirect(route('admin'));

        Block::update_block($request->id, $request->type, $request, 'layouts');

        ThemeLayoutBlock::where('id', $request->id)->update(['label' => $request->label ?? null, 'updated_by_user_id' =>  Auth::user()->id, 'hide' => $request->hide ? 1 : 0]);

        if (($request->submit_return_to_block ?? null) == 'block') return redirect(route('admin.theme.layouts.block', ['id' => $request->id, 'referer' => $request->referer ?? null]))->with('success', 'updated');
        elseif ($request->referer) return redirect($request->referer)->with('success', 'updated');
        else return redirect(route('admin.templates'))->with('success', 'updated');
    }
}
