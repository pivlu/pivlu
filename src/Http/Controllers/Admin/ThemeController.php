<?php

/**
 * Pivlu - Open source CMS (Content Management System).
 * Pivlu comes with the complete suite of tools that any business, team, or website owner needs.
 * https://pivlu.com
 *
 * Copyright (c) Chimilevschi Iosif-Gabriel
 * LICENSE:
 * Permissions of this strongest copyleft license are conditioned on making available complete source code 
 * of licensed works and modifications, which include larger works using a licensed work, under the same license. 
 * Copyright and license notices must be preserved. Contributors provide an express grant of patent rights. 
 * When a modified version is used to provide a service over a network, the complete source code of the modified version must be made available.
 *    
 * @copyright   Copyright (c) Chimilevschi Iosif-Gabriel
 * @license     https://opensource.org/license/agpl-v3  AGPL-3.0 License.
 * @author      Chimilevschi Iosif-Gabriel <office@pivlu.com>
 * 
 *  DO NOT edit this file manually. All changes will be lost after software update. For custom changes, use templates ans plugins system.
 */

namespace Pivlu\Http\Controllers\Admin;

use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\Validator;
use Illuminate\Support\Str;
use Pivlu\Models\Config;
use Pivlu\Models\Theme;
use Pivlu\Models\Plugin;
use Pivlu\Models\Language;
use Pivlu\Models\ThemeConfig;
use Pivlu\Models\ThemeConfigLang;
use Pivlu\Models\ThemeStyle;
use Pivlu\Models\ThemeButton;
use Pivlu\Models\ThemeFooter;
use Pivlu\Models\ThemeMenu;
use Pivlu\Models\BlockType;
use Pivlu\Models\PostType;
use Pivlu\Functions\ThemeFunctions;
use Pivlu\Functions\FileFunctions;

class ThemeController extends Controller
{

    public function index(Request $request)
    {

        $themes = Theme::orderByDesc('is_active')->orderByDesc('id')->paginate(25);

        return view('pivlu::admin.index', [
            'view_file' => 'admin.theme.index',
            'active_menu' => 'website',
            'active_submenu' => 'themes',
            'nav_tab' => 'themes',
            'themes' => $themes,
        ]);
    }


    /**
     * Store resource
     */
    public function store(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'name' => 'required',
        ]);

        if ($validator->fails()) return redirect(route('admin.themes.index'))->withErrors($validator)->withInput();

        $slug = Str::slug($request->name, '_');

        if (Theme::where('slug', $slug)->exists()) return redirect(route('admin.themes.index'))->with('error', 'duplicate');

        Theme::create(['label' => $request->name, 'slug' => $slug]);

        return redirect(route('admin.themes.show', ['slug' => $slug]))->with('success', 'created');
    }



    /**
     * Show resource
     */
    public function show(Request $request)
    {
        $theme = Theme::find($request->id)->first();
        if (! $theme) return redirect(route('admin.themes.index'));

        $theme_tab = $request->theme_tab ?? 'general';
        $accepted_tabs = ['general', 'home', 'style', 'nav', 'footer'];

        $post_types = PostType::orderByDesc('core')->orderByDesc('active')->orderByDesc('id')->paginate(25);
        $post_types_tabs = [];
        foreach ($post_types as $post_type) {
            array_push($accepted_tabs, $post_type->type);
            $post_types_tabs[$post_type->type] = $post_type->default_language_content->name;
        }

        if (!in_array($theme_tab, $accepted_tabs)) $theme_tab = 'general';
        if (isset($post_types_tabs[$theme_tab])) {
            $post_type_tab = $post_types_tabs[$theme_tab];
            $theme_tab = 'post-type';
        }

        if ($theme_tab == 'general') {
            $homepage_content_sources_post_types = PostType::where('type', '!=', 'page')->where('active', 1)->orderBy('id')->get();
            $homepage_content_sources_plugins = Plugin::where('can_be_homepage_source', 1)->where('status', 'active')->orderBy('name')->get();
        }

        if ($theme_tab == 'nav') {
            $nav_templates = [];
            $nav_templates_folders = glob(resource_path('views/template-parts/navigations/' . '*'), GLOB_ONLYDIR); // frontend 
            foreach ($nav_templates_folders as $nav_templates_folder) {
                $nav_template_json = resource_path('views/template-parts/navigations/' . basename($nav_templates_folder) . '/nav.json');
                if (file_exists($nav_template_json)) {
                    $string = file_get_contents($nav_template_json);
                    $json_data = json_decode($string);
                    $nav_templates[] = ['slug' => basename($nav_templates_folder), 'name' => $json_data->name, 'author' => $json_data->author, 'description' => $json_data->description, 'screenshot' => $json_data->screenshot];
                }
            }
        }

        return view('pivlu::admin.index', [
            'view_file' => 'admin.theme.show',
            'active_menu' => 'website',
            'active_submenu' => 'themes',
            'nav_tab' => 'themes',
            'theme' => $theme,
            'theme_tab' => $theme_tab,
            'post_types_tabs' => $post_types_tabs,
            'post_type_tab' => $post_type_tab ?? null,

            'fonts' => ThemeFunctions::fonts(),
            'font_sizes' => ThemeFunctions::font_sizes(),
            'buttons' => ThemeButton::orderByDesc('is_default')->orderBy('label')->get(),
            'styles' => ThemeStyle::orderByDesc('is_default')->orderBy('label')->get(),
            'footers' => ThemeFooter::orderByDesc('is_default')->orderBy('label')->get(),
            'menus' => ThemeMenu::orderByDesc('is_default')->orderBy('label')->get(),
            'theme_config' => ThemeConfig::config($theme->id),

            'block_types' => BlockType::get_block_types(), // for homepage tab

            'nav_templates' => $nav_templates ?? null, // for nav tab

            'homepage_content_sources_post_types' => $homepage_content_sources_post_types ?? null,
            'homepage_content_sources_plugins' => $homepage_content_sources_plugins ?? null
        ]);
    }



    /**
     * Update settings
     */
    public function update(Request $request)
    {
        $theme = Theme::find($request->id)->first();
        if (! $theme) return redirect(route('admin.themes.index'));

        $theme_tab = $request->theme_tab;

        $excepts = array('_token', '_method', 'theme_tab');

        if ($theme_tab == 'general') {
            foreach (Language::get_languages() as $lang) {
                ThemeConfigLang::update_config($theme->id, $lang->id, 'homepage_meta_title', $request['homepage_meta_title_' . $lang->id] ?? null);
                ThemeConfigLang::update_config($theme->id, $lang->id, 'homepage_meta_description', $request['homepage_meta_description_' . $lang->id] ?? null);
            }
            ThemeConfig::update_config($theme->id, 'homepage_source', $request->homepage_source ?? null);
        } else {
            // request inputs WITHOUT files
            $inputs = $request->except($excepts);
            //dd($inputs);
            ThemeConfig::update_config($theme->id, $inputs);
        }

        if ($theme_tab == 'style' || $theme_tab == 'nav') ThemeFunctions::generate_theme_css($theme->code);

        if ($theme_tab == 'nav') {
            $menu_id = $request->menu_id;
            if (! $menu_id) $menu_id = ThemeMenu::where('is_default', 1)->value('id');
            $theme->update(['menu_id' => $menu_id]);
        }

        return redirect(route('admin.themes.show', ['id' => $theme->id, 'theme_tab' => $theme_tab]))->with('success', 'updated');
    }


    /**
     * Update template part settings
     */
    public function update_template_part(Request $request)
    {
        $theme = Theme::find($request->id)->first();
        if (! $theme) return redirect(route('admin.themes.index'));

        $theme_tab = $request->theme_tab;

        $excepts = array('_token', '_method', 'theme_tab');

        $inputs = $request->except($excepts);

        ThemeConfig::update_template_part_config($theme->id, $request->template_part, $inputs);

        return redirect(route('admin.themes.show', ['id' => $theme->id, 'theme_tab' => $theme_tab]))->with('success', 'updated');
    }



    /**
     * Set active template
     */
    public function set_active(Request $request)
    {
        $theme = Theme::find($request->id)->first();
        if (! $theme) return redirect(route('admin.themes.index'));

        Config::update_config('active_theme', $theme->id);

        Theme::where('code', $theme->code)->update(['is_active' => 1]);
        Theme::where('slug', '!=', $theme->cide)->update(['is_active' => 0]);

        // create theme css file IF NOT EXISTS (do not overwrite if exists)
        $theme_css_file = 'assets/css/themes/' . $theme->code . '.css';
        if (!file_exists($theme_css_file)) {
            $css_file = fopen($theme_css_file, "w");
            $write = " ";
            fwrite($css_file, $write);
            fclose($css_file);

            ThemeFunctions::generate_theme_css($theme->code);
        }

        return redirect(route('admin.themes.index'))->with('success', 'updated');
    }


    /**
     * Process Template logos
     */
    public function update_logo(Request $request)
    {

        $theme = Theme::find($request->id)->first();
        if (! $theme) return redirect(route('admin.themes.index'));

        // process Main logo image
        if ($request->hasFile('logo')) {
            $validator = Validator::make($request->all(), [
                'logo' => 'mimes:jpeg,jpg,png,gif',
            ]);

            if (!$validator->fails()) {
                $media = FileFunctions::store_file($request->file('logo'));
                if ($media) ThemeConfig::update_config($theme->id, 'logo_media_id', $media->id);
            }
        }


        // pricess favicon image
        if ($request->hasFile('favicon')) {

            $validator = Validator::make($request->all(), ['favicon' => 'mimes:jpeg,jpg,png,gif,ico']);

            if (!$validator->fails()) {
                $media = FileFunctions::store_file($request->file('favicon'));
                if ($media) ThemeConfig::update_config($theme->id, 'favicon_media_id', $media->id);
            }
        }

        return redirect(route('admin.themes.show', ['id' => $theme->id, 'theme_tab' => 'general']))->with('success', 'updated');
    }


    /**
     * Template custom code page
     */
    public function custom_code()
    {
        return view('pivlu::admin.index', [
            'view_file' => 'admin.theme.custom-code.index',
            'nav_section' => 'website',
            'active_menu' => 'themes',
            'nav_tab' => 'custom_code',
        ]);
    }

    /**
     * Process temmplate tools page
     */
    public function update_custom_code(Request $request)
    {
        $inputs = $request->except('_token');

        Config::update_config($inputs);

        return redirect($request->Url())->with('success', 'updated');
    }
}
