<?php

/**
 * Pivlu - Open source CMS (Content Management System).
 * Pivlu comes with the complete suite of tools that any business, team, or website owner needs.
 * https://pivlu.com
 *
 * Copyright (c) Chimilevschi Iosif-Gabriel
 * LICENSE:
 * Permissions of this strongest copyleft license are conditioned on making available complete source code 
 * of licensed works and modifications, which include larger works using a licensed work, under the same license. 
 * Copyright and license notices must be preserved. Contributors provide an express grant of patent rights. 
 * When a modified version is used to provide a service over a network, the complete source code of the modified version must be made available.
 *    
 * @copyright   Copyright (c) Chimilevschi Iosif-Gabriel
 * @license     https://opensource.org/license/agpl-v3  AGPL-3.0 License.
 * @author      Chimilevschi Iosif-Gabriel <office@pivlu.com>
 * 
 *  DO NOT edit this file manually. All changes will be lost after software update. For custom changes, use templates ans plugins system.
 */

use Pivlu\Models\Config;
use Pivlu\Models\ConfigLang;
use Pivlu\Models\Language;
use Pivlu\Models\Post;
use Pivlu\Models\PostType;
use Pivlu\Models\ThemeButton;
use Pivlu\Models\ThemeConfig;
use Pivlu\Models\Theme;
use Pivlu\Models\ThemeFooter;
use Pivlu\Functions\PostFunctions;

if (!function_exists('theme_asset')) {
	function theme_asset($file = null)
	{
		$active_theme = Theme::get_active_theme();
		return asset('vendor/' . $active_theme->vendor_name . '/' . $active_theme->package_name) . '/' . $file;
	}
}


if (!function_exists('theme_view')) {
	function theme_view($file = null)
	{
		$active_theme = Theme::where('is_active', 1)->first();

		return ($active_theme->views_hint ?? 'pivlu') . '::' . $file;
	}
}


if (!function_exists('get_style')) {
	function get_style($style)
	{
		$id = ThemeStyle::where('style', $style)->value('id');

		return 'style_' . $id;
	}
}



if (!function_exists('theme_posts')) {
	function theme_posts($type = null, $args = array())
	{
		if (!$type) $type = 'post';

		$per_page = $args['posts_per_page'] ?? 24;

		$post_type = PostType::where('type', $type)->first();
		if (! $post_type) return null;

		$items = Post::with('active_language_content', 'user')->where('post_type_id', $post_type->id)->where('status', 'published')->orderByDesc('id')->paginate($per_page);

		foreach ($items as $item) {
			//dd(avatar($item->user, 'thumb'));
			$item->title = $item->active_language_content->title;
			$item->summary = $item->active_language_content->summary;
			$item->image = first_media_url($item, 'post_media', 'small');
			$item->author_name = $item->user->name;
			$item->author_avatar = avatar($item->user, 'thumb');
			$item->url = $item->active_language_content->url;
		}

		return $items;
	}
}


if (!function_exists('button')) {
	function button($id)
	{
		if (!$id) return null;
		$button = ThemeButton::find($id);
		return $button;
	}
}


if (!function_exists('get_theme_styles')) {
	function get_theme_styles()
	{
		$styles_html = '';

		// Get block styles css
		$styles_html .= '<link rel="stylesheet" href="' . asset('custom/styles.css') . '" /> ';

		// Get theme styles css
		$active_theme = Theme::get_active_theme();
		if ($active_theme) $styles_html .= '<link rel="stylesheet" href="' . asset('custom/themes/' . $active_theme->code . '.css') . '" /> ';

		return nl2br($styles_html);
	}
}
